
<!DOCTYPE html>

<!--
TODO: Add keyup to input
TODO: Add parse to script

TODO: Edit send such that it creates a new object with the text as content.
-->
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="bootstrap/bootstrap.css"/>
    <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,200,300,600,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="stylesheet.css"/>

    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <title>Chatbuilder</title>
    <script src="http://www.parsecdn.com/js/parse-1.5.0.min.js"></script>
    <script src="Chart.min.js"></script>

  </head>
  <body>

    <script>
    Parse.initialize("qFmAD2tzjvkYAaU9XqaLOx8NAc7EMwvmqBozHoqb", "T5MnnNzlZy2rSnB1rx6hPF2iwG3nuMrFyneGPFGY");
    /*
    var TestObject = Parse.Object.extend("TestObject");
    var testObject = new TestObject();
    testObject.save({foo: "bar"}).then(function(object) {
      alert("yay! it worked");
    });
    */
      /*
       *  Nice, you found the HTML source code for ChatBuilder! This document kicks everything off when you load it
       *  in your browser, and is a starting point for the whole app. It's pretty incomplete though--you should
       *  make your own version of it that works better!
       *
       *  You can't edit the code here until it's in a file on your hard drive, so copy this whole page of source
       *  code and paste it into a plain text editor like Sublime Text 2 (http://www.sublimetext.com/). Save it as
       *  a `.html` file, and open that file with Google Chrome. You can now edit it however you like, and refresh
       *  the page to see your modifications take effect on how the application runs.
       *
       *  Fair warning: one or more of the steps ahead could require a good amount of research to understand all
       *  the terms and technologies mentioned. Googling words you haven't heard before is a great idea. Just be
       *  careful not to spend too long in 'research mode' without making any forward progress on your real goal of
       *  completing the app!
       *
       *  When you've got this code saved as a local file, uncomment the line of JavaScript code below and open
       *  the new file in Google Chrome. Your next instructions will be waiting for you in the JavaScript console.
       *  If you already know the Chrome JS development tools pretty well, feel free to skip this opening tutorial
       *  by calling the `.start()` function on `Chat.guide` instead of `.intro()`
       *
       *  NOTE: Please do not publish or share any of the code associated with this challenge. We've worked really
       *  hard to build this material and publishing solutions diminishes its effectiveness.
       */


      //When send button is clicked
        //Apply the box's innerText to a local variable
        //Send the local var
        //Clear the innerText
        //Display the new

//TODO: Lots of repeat items every time, either:
  //don't give me the repeat items
  //filter repeated items
//


var hidden = false;
var user = prompt("What is your name?");

//descending: [10,9,8,7,]
  //prepend cache: 7,8,9,10
    //prepend new: 11,7,8,9,10
    //append new: 7,8,9,10,11
  //append cache: 10,9,8,7,6
    //prepend new: 11,10
    //append new: 7,6,11

//Display Function
var displayLoad = function(string){
  $("ul").append("<li>" + string + "</li>");
};

var display = function(string){
  $("ul").prepend("<li>" + string + "</li>");
}


var objectIDArray = [];

//function that true/false if the objectID has already been posted
var checkIfPosted = function(string){
  var holder = string;
  //console.log(string);
  for(i=0; i<objectIDArray.length;i++){
    //console.log(objectIDArray[i]);
    if(holder == objectIDArray[i]){return true}
  }
  return false;
};


//Fetch Function
var fetch = function(callback){

  var Chats = Parse.Object.extend("chats");
  var query = new Parse.Query(Chats);

  query.descending("createdAt");
  query.limit(25);
  query.find({
    success: function(results){
      //console.log(results);
      results.forEach(function(obj){
        var bool = checkIfPosted(obj.id);
        if(!bool){
            objectIDArray.push(obj.id);
            callback(obj.createdAt.toString().slice(16,22)+" "+obj.attributes.username + " - " +obj.attributes.text);
          }
        })
      },

    error: function(error){
      console.log(error.message);
    }

  });
};

//Send Function
var send = function (string){
  var json = JSON.stringify({text: string});

  var ChatObject = Parse.Object.extend("chats");
  var chatObject = new ChatObject();
  chatObject.save({text:string,username:user});

  fetch(function(text){
    display(text);
  })
};




//Function that sends to the cloud, at the click. click passes in callback not invoked function
$(document).ready(function(){
  $(".send").click(function(){
    chat = $(".draft").val();
    send(chat);
    $(".draft").val('');
    $("p.word-count").text('140');
  });
});


/* this works, but i need it to only fetch new messages*/
$(document).ready(function(){
  setInterval(function(){
    //toggleRobo();
    fetch(function(text){
      display(text);
    })
    }
  , 3000)
    });

$(document).ready(function(){
  $('textarea').click(function(){
    $(this).rows="10";
    //console.log("you clicked")
  })
})

var toggleRobo = function(){

  $('.hide-robo').click(function(){
      $('li').each(function(){
        hidden = true;
        var holder = $(this).text();
        if(holder.slice(8,16)=="RoboChat"){
          $(this).hide();

        }
      })
  })

  $('.show-robo').click(function(){
    $('li').each(function(){
      hidden=false;
      var holder = $(this).text();
      if(holder.slice(8,16)=="RoboChat"){
        $(this).show();
      }
    })
  })

}

var wordCount = function(){
  $('button').prop('disabled', true);
  $('textarea').keyup(function(){
    var inputLength = $('.draft').val().length;
    wordsLeft = 140-inputLength;
    $('p.word-count').text(wordsLeft);
    if(wordsLeft<=0 || wordsLeft==140){$('button').prop('disabled', true);}
    else $('button').prop('disabled', false);

  })

}


$(document).ready(toggleRobo);
$(document).ready(fetch(function(text){
  displayLoad(text);}))

$(document).ready(wordCount);

var chart = function(){
  var ctx = document.getElementById("myChart").getContext('2d');
  Chart.defaults.global.responsive = true;
  var data= {
    labels: [6,5,4,3,2,1,"Today"],
    datasets: [
      {label: "Posts/Day",
      fillColor:"rgba(220,220,220,0.2)",
      strokeColor: "rgba(220,220,220,1)",
      pointColor: "rgba(220,220,220,1)",
      pointStrokeColor: "#fff",
      pointHighlightFill: "#fff",
      pointHighlightStroke: "rgba(220,220,220,1)",
      data: [65, 59, 80, 81, 56, 55, 100]
      }
    ]
  }
  var myNewChart = new Chart(ctx).Line(data);

}
$(document).ready(chart);



//keyup for twitter counter should only allow a certain amount

</script>

    <div class="header">
      <div class="col-sm-6 left">
        <img src="logo.png"/>
      </div>
      <div class="col-sm-6 right">
        <h3>Twixter</h3>
      </div>

    </div>

    <div class="container">
      <div class="row first-row">
        <div class="col-sm-4 border profile gray">
          <h2>Being Added</h2> <hr>
          <ol>
            <li>
              <strike>Word count so that you cannot submit over 140 chars or 0 chars.</strike>
            </li>
            <li>
              Responsive design for better mobile experience
            </li>
            <li>
              Make chart dynamic to with Query from Parse
            </li>
            <li>
              Load additional items once scrolling to the bottom of the page.
            </li>
            <li>
              Enter to send.
            </li>
          </ol>

          <p>
            -Submit feature requests with [feature] tag. <br>
            -Report bugs with [bug] tag.
          </p>
          <hr>
          <p>
            <strong>Built using:</strong> <br>
            HTML/CSS/Bootstrap <br>
            JS/jQuery<br>
            Parse/Chart.js
          </p>
        </div>


          <!--
          <div class="row profile-background blue">
          </div>
          <div class="row profile-background">
          </div> -->



        <div class="col-sm-7 border">
          <div class="row title">
            <h1 class="title">"Tweets" per day</h1>
          </div>
          <div class = "row">

            <canvas id="myChart" width="400" height="200"></canvas>

          </div>
          <div class="row input-row">
            <textarea id="textarea" placeholder="What's on your mind?" class="draft" rows="3" type="text"></textarea>
          </div>
          <div class="row input-row count-submit">

            <button class="send" type = "submit">Send</button>
            <p class="word-count">
              140
            </p>
          </div>

        <!--
        <div class="row">
          <div class="col-sm-6 robo-button-left">
            <button class="hide-robo">Hide RoboChat</button>
          </div>
          <div class="col-sm-6 robo-button-right">
              <button class="show-robo">Show RoboChat</button>
          </div>

        </div>
      -->


        <div class="row">
          <ul class="messages"></ul>
        </div>


        </div>
      </div>
    </div>





  </body>
</html>
